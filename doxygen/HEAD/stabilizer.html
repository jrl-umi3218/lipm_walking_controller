<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=9"/>
    <meta name="generator" content="Doxygen 1.8.17"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Tuning the stabilizer - LIPM Walking Documentation</title>
    <link href="tabs.css" rel="stylesheet" type="text/css"/>
    <link href="doxygen.css" rel="stylesheet" type="text/css">
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX","output/SVG"],
      });
    </script>
    <script src="MathJax/MathJax.js"></script>
    <script type="text/javascript" src="jquery.js"></script>
    <script type="text/javascript" src="dynsections.js"></script>
    <link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
    <link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
    <style type="text/css">
      #projectname {
        font-size: 200%;
      }
      #projectname a {
        color: #78B;
        font-family: monospace;
        font-size: 110%;
        font-stretch: semi-condensed;
        font-weight: bold;
        text-decoration: none;
      }
    </style>
  </head>
  <body>
  <div id="top"><!-- do not remove this div, it is closed by doxygen! -->
    <div id="titlearea">
      <table cellspacing="0" cellpadding="0">
        <tbody>
          <tr style="height: 56px;">
            <td id="projectalign" style="padding: 0.5em 1em;">
              <div id="projectname">
                <a href="index.html">
                  lipm_walking_controller
                </a>
                <span id="projectnumber">
                  1.6.0
                </span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('stabilizer.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Tuning the stabilizer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The stabilizer performs feedback control to make the robot track the desired walking pattern. The stabilizer of this controller is based on <a href="https://doi.org/10.1109/IROS.2010.5651082">linear inverted pendulum tracking</a>. It is documented in the following <a href="https://hal.archives-ouvertes.fr/hal-01875387/document">paper</a>, <a href="https://scaron.info/slides/jpl-2019.pdf">slides</a> and <a href="https://scaron.info/files/icra-2019/poster.pdf">poster</a>. Let us discuss the process of tuning its gains.</p>
<h1><a class="anchor" id="gains"></a>
Feedback gains</h1>
<p>There are two sets of gain to tune in the stabilizer: <em>admittance gains</em> (force control) and <em>DCM tracking gains</em> (floating base control). We cannot achieve perfect position and force control at the same time due to <em>e.g.</em> delays and modeling errors; what we are aiming for is a compromise between the two, for a given task (usually walking).</p>
<p>As a first approximation, we can imagine that these gains tune the compliance/stiffness of the floating base of the robot (recall that we don't control the DCM <em>per se</em> but <a href="https://scaron.info/slides/jpl-2019.pdf#page=28">because it is the best way to control the floating base</a>). Larger admittances make the floating base more compliant, improving force control in the short term but potentially degrading position tracking in the long term. Meanwhile, larger DCM tracking gains make the floating base stiffer, improving position tracking in the short term but yielding oscillations for high values. The threshold at which these oscillations appear depends on admittances (larger admittances lower the threshold).</p>
<p>Here is the list of main gains to configure and their rule-of-thumb effect:</p>
<h2><a class="anchor" id="dcm"></a>
DCM Tracking</h2>
<table class="doxtable">
<tr>
<td><b>Gain</b></td><td><b>Effect of increasing</b> </td></tr>
<tr>
<td><em>Proportional</em></td><td>Stiffens position control </td></tr>
<tr>
<td><em>Integral</em></td><td>Reduces steady-state error, stiffens position control </td></tr>
<tr>
<td><em>ZMP</em></td><td>Damps oscillations (allows higher proportional gain) but increases position compliance </td></tr>
</table>
<p>Ideally we would like these gains to be as low as possible. Larger modeling errors increase steady state error: we can compensate them (for the static part) by increasing the integral gain, but a large integral gain also has drawbacks (<em>e.g.</em> slow convergence if the integrator time constant is large, or risk of oscillations otherwise). Improving the model is, when possible, a more principled way to address the problem at its root.</p>
<p>As an example, until version 1.3 of the controller we introduced a modeling error in wrench distribution discussed in <a href="https://github.com/stephane-caron/lipm_walking_controller/issues/28">this issue</a>. With v1.3 running on the HRP-2Kai humanoid, we could go down to a DCM proportional gain <code>P=4</code>: at <code>P=3</code>, the robot was marginally stable, complying to perturbations without returning to the desired equilibrium in standing tests. From version 1.4, we could take the gain down to <code>P=3</code> (even <code>P=2</code>).</p>
<h2><a class="anchor" id="admittance"></a>
Admittance control</h2>
<table class="doxtable">
<tr>
<td><b>Gain</b></td><td><b>Effect of increasing</b> </td></tr>
<tr>
<td>Foot: <em>CoPx</em></td><td>Improves CoP control but increases sagittal position compliance </td></tr>
<tr>
<td>Foot: <em>CoPy</em></td><td>Improves CoP control but increases lateral position compliance </td></tr>
<tr>
<td>Legs: <em>DFz</em></td><td>Improves foot force difference tracking in double support, can yield vertical oscillations </td></tr>
<tr>
<td>Legs: <em>DFz damping</em></td><td>Damps potential oscillations in double support </td></tr>
<tr>
<td>CoM: <em>Ax</em></td><td>Improves ZMP control but increases sagittal position compliance </td></tr>
<tr>
<td>CoM: <em>Ay</em></td><td>Improves ZMP control but increases lateral position compliance </td></tr>
</table>
<p>You can debug them with the <code>Tracking DCM X/Y</code> and <code>Tracking DCM-ZMP X/Y</code> plots, except for the foot <em>DFz</em> admittance which is better checked in <code>Foot force both</code>.</p>
<h1><a class="anchor" id="tests"></a>
Standard tests</h1>
<p>We mainly evaluate controller performance by plotting DCM and ZMP trajectories. All plots discussed below are distributed in a plot configuration for <code>mc_log_ui</code> that you can install as follows:</p>
<div class="fragment"><div class="line">ayumi:~$ mkdir -p ~/.config/mc_log_ui</div>
<div class="line">ayumi:~/.config/mc_log_ui$ ln -s ~/lipm_walking_controller/etc/mc_log_ui/custom_plot.json</div>
</div><!-- fragment --><p>Open the plotting GUI for the last run of the controller by:</p>
<div class="fragment"><div class="line">ayumi:~$ mc_log_ui /tmp/mc-control-LIPMWalking-latest.bin</div>
</div><!-- fragment --><p>By default, <a class="el" href="namespacemc__rtc.html" title="Framework namespace, only used to add a configuration loader.">mc_rtc</a> stores all your controller logs in <code>/tmp</code>. They will stay there until you reboot your machine.</p>
<h2><a class="anchor" id="standing"></a>
Standing</h2>
<p>Standing tests evaluate the performance of disturbance rejection when you push the robot around.</p>
<ul>
<li>Put the robot on the ground in standing posture</li>
<li>Push the robot sagitally or laterally so that the measured ZMP at ground level lies between its rest position and the boundary of the support area</li>
<li>Stop pushing</li>
<li>Observe how the DCM returns to equilibrium</li>
</ul>
<p>Here is an example from a Choreonoid simulation of the HRP-4 model:</p>
<p><img src="pictures/plots/sim_hrp4_dcm_pi_1_10.png" alt="" width="49%" align="left" class="inline"/> <img src="pictures/plots/sim_hrp4_dcm_pi_2_5.png" alt="" width="49%" align="left" class="inline"/> </p><div style="clear: both"></div><p>On the left-hand plot, DCM proportional and integral gains were set to <code>P=1</code> and <code>I=10</code>, and we see that the DCM is overdamped. On the right-hand plot, gains were set to <code>P=2</code> and <code>I=5</code>, yielding a better performance (the DCM is only slightly underdamped). Note that the choice of PID gains for DCM tracking is affected by admittances: larger admittances tend to increase overshoot, but also decrease return time. To address this, <a href="https://doi.org/10.1109/IROS.2010.5651082">Kajita et al.</a> chose to collectively model the performance of force control by a first order lag (whose time constant depends on all admittance gains). <a href="https://doi.org/10.1109/SII.2014.7028007">Morisawa et al.</a> use this model for gain tuning. Since v1.2 of the controller, you can try it in the <code>Stabilizer</code> → <code>Advanced</code> → <code>DCM pole placement</code> input of the GUI.</p>
<h2><a class="anchor" id="ashibumi"></a>
Walking in place</h2>
<p>Walking in place evaluates the lateral walking performance and is cheap to reproduce. It corresponds to the <code>ashibumi</code> plan loaded from configuration file (from Japanese 足踏み which means "walking in place"; it has the benefit of beginning with an 'a' so that the plan appears first in the list). Use it to evaluate the effect of different feedback gains on lateral DCM tracking performance over several walking cycles. Here are two examples.</p>
<h3><a class="anchor" id="autotoc_md0"></a>
Increasing foot CoP admittances</h3>
<p>Here are two plots ran on the HRP-4 hardware where we increased ankle CoP admittances from <code>0.01</code> to <code>0.02</code>:</p>
<p><img src="pictures/plots/hrp4_increase_cop_adm_01.png" alt="" width="49%" align="left" class="inline"/> <img src="pictures/plots/hrp4_increase_cop_adm_02.png" alt="" width="49%" align="left" class="inline"/> </p><div style="clear: both"></div><p>You can see that the force tracking is improved (green <code>realRobot_zmp_y</code> curve is closer to its violet <code>stabilizer_zmp_y</code> target), however DCM tracking degrades, and as a consequence the stabilizer ZMP target shifts further away from the blue reference <code>pendulum_zmp_y</code> from the motion plan. Since our ultimate goal is to control the DCM, the first setting is better than the second one.</p>
<h3><a class="anchor" id="autotoc_md1"></a>
Increasing the DCM proportional gain</h3>
<p>Here are two plots ran on the HRP-4 hardware (v1.0 of the controller) where we increased the proportional gain of DCM tracking from <code>1</code> to <code>2</code>:</p>
<p><img src="pictures/plots/hrp4_increase_dcm_k_1.png" alt="" width="49%" align="left" class="inline"/> <img src="pictures/plots/hrp4_increase_dcm_k_2.png" alt="" width="49%" align="left" class="inline"/> </p><div style="clear: both"></div><p>Although DCM tracking is improved at the beginning of the first step, we can see that the performance is <em>degraded</em> in the long run for the higher DCM gain. After a couple of steps, DCM tracking performance is roughly the same, at the cost of much larger ZMP targets (<code>stabilizer_zmp_y</code> violet curve). We see also in the spikes in measured ZMP (<code>realRobot_zmp_y</code> green curve) that the second setting yields larger touchdown impacts.</p>
<h2><a class="anchor" id="forward"></a>
Walking forward</h2>
<p>Walking forward is the last test in our pipeline. It corresponds to the <code>walk_forward_100cm</code> plan loaded from the configuration file.</p>
<h3><a class="anchor" id="autotoc_md2"></a>
Increasing the DCM integral gain</h3>
<p>Here are two plots from a Choreonoid simulation of HRP-2Kai (v1.6 of the controller) where we increased the integral gain of DCM tracking from <code>20</code> (left) to <code>42</code> (right):</p>
<p><img src="pictures/plots/sim_hrp2_increase_integral_20_x.png" alt="" width="49%" align="left" class="inline"/> <img src="pictures/plots/sim_hrp2_increase_integral_42_x.png" alt="" width="49%" align="left" class="inline"/> </p><div style="clear: both"></div><p>Performance is better on the right-hand side, with both the DCM and ZMP closer to their references. Having the ZMP closer to the ankle frame (which is offset backward from the sole center) is also better to minimize deflection of the flexibility, which in turns reduces our kinematic tracking error and eventually reduces impact.</p>
<p>Here are plots in the lateral direction from the same simulation, walking three meters forward this time:</p>
<p><img src="pictures/plots/sim_hrp2_increase_integral_20_y.png" alt="" width="49%" align="left" class="inline"/> <img src="pictures/plots/sim_hrp2_increase_integral_42_y.png" alt="" width="49%" align="left" class="inline"/> </p><div style="clear: both"></div><p>During the first steps the performance seems slightly degraded, as with a higher integral gain the integrator converges to its steady state behavior faster. We can check this by plotting its error curve:</p>
<p><img src="pictures/plots/sim_hrp2_increase_integral_20_error.png" alt="" width="49%" align="left" class="inline"/> <img src="pictures/plots/sim_hrp2_increase_integral_42_error.png" alt="" width="49%" align="left" class="inline"/> </p><div style="clear: both"></div><p>Note that this behavior is general: the integrator "eats up" all our unmodeled effects, so while standing it will converge to a stationary value, and while walking it will drift step by step until reaching repeating oscillations. Overall, our performance loss is only transient and the overall lateral walking performance is not degraded with the higher integral gain. We can conclude that it is thus a better choice for this simulation.</p>
<h1><a class="anchor" id="optional"></a>
Optional tunings</h1>
<h2><a class="anchor" id="integrator"></a>
DCM integrator</h2>
<p>The integrator used to evaluate the average DCM over time is an <a href="https://en.wikipedia.org/wiki/Moving_average#Exponential_moving_average">exponential moving average</a> (EMA) over the last <img class="formulaInl" alt="$T_i$" src="form_0.png"/> seconds (see utils::ExponentialMovingAverage). The nominal value for HRP-4 is <img class="formulaInl" alt="$T_i = 10~\text{s}$" src="form_1.png"/>, which works well in all cases we tested so far.</p>
<p>If you observe slow oscillations during standing after walking, your integrator time constant may be too large. We observed this behavior on HRP-2Kai while experimenting with <img class="formulaInl" alt="$T_i = 15~\text{s}$" src="form_2.png"/>. In this case, you may want to reduce your integrator time constant or increase your DCM P gain. Smaller time constants reduce the cutoff period of the EMA and thus make the DCM integral term closer to a proportional one. This is not the intended behavior, so if possible you should increase your DCM P gain instead. Look at your average DCM error variations (<code>error_dcm_average</code> log entry) to decide on a course of action.</p>
<h2><a class="anchor" id="vdc"></a>
Vertical drift control</h2>
<p>Additionally, there are two gains for vertical drift control:</p>
<table class="doxtable">
<tr>
<td><b>Gain</b></td><td><b>Effect of increasing</b> </td></tr>
<tr>
<td><em>frequency</em></td><td>Faster foot height averaging in double support </td></tr>
<tr>
<td><em>stiffness</em></td><td>Faster foot height drift correction in single support </td></tr>
</table>
<p>These gains are not critical, their purpose is to avoid long-term drift after several steps. Use the <code>Swing foot Z</code> plot to debug them. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.6-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed Jun 7 2023 02:05:17 for lipm_walking_controller by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
